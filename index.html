<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cálculo de Importação</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-size: contain;
      background-position: top center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: #003366;
    }

    .overlay {
      background-color: rgba(255, 255, 255, 0.88);
      max-width: 700px;
      margin: 20px auto 40px;
      padding: 30px 20px;
      box-sizing: border-box;
      border-radius: 8px;
      min-height: auto;
    }

    /* Títulos */
    h1, h2 {
      font-family: Verdana, sans-serif;
      font-size: 18px;
      color: #003366;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    /* Mensagem logo após o título principal */
    #mensagemOperacao {
      font-family: Verdana, sans-serif;
      font-size: 10px;
      color: #003366;
      font-weight: 600;
      margin: 0 0 20px 0;
      text-align: center;
    }

    /* Labels e títulos pequenos */
    label {
      display: block;
      margin-top: 10px;
      font-family: Verdana, sans-serif;
      font-size: 10px;
      color: #003366;
      font-weight: 600;
    }

    /* Inputs e selects */
    input, select {
      font-family: Verdana, sans-serif;
      font-size: 10px;
      color: #003366;
      font-weight: 600;
      width: 100%;
      margin: 8px 0 12px 0;
      box-sizing: border-box;
      padding: 5px;
    }

    input[readonly] {
      background-color: #e9e9e9;
      cursor: not-allowed;
    }

    /* Container dos resultados */
    .section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-family: Verdana, sans-serif;
      font-size: 10px;
      color: #003366;
      font-weight: 600;
      text-align: right;
    }

    th {
      background-color: #f2f2f2;
    }

    /* Alinha as 2 primeiras colunas da tabela à esquerda */
    td:first-child, td:nth-child(2) {
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1>Cálculo de Importação</h1>

    <div id="mensagemOperacao">
      Para essa operação utilizar o produto SER105100 e a natureza 6002.
    </div>

    <label>Nome do Fornecedor:
      <input type="text" id="fornecedor" />
    </label>

    <label>Data do Pagamento:
      <input type="date" id="dataPagamento" />
    </label>

    <!-- Campos de datas adicionais bloqueados -->
    <label id="labelDataPisIr" class="hidden">Data de Pagamento do PIS/COFINS e IR:
      <input type="date" id="dataPisIr" readonly />
    </label>

    <label id="labelDataCide" class="hidden">Data de Pagamento do CIDE:
      <input type="date" id="dataCide" readonly />
    </label>

    <label>Número da Invoice:
      <input type="text" id="invoice" />
    </label>

    <label>Valor Pago em Real:
      <input type="number" id="valorPago" step="0.01" />
    </label>

    <label>IR já foi pago (câmbio)?
      <select id="irPago">
        <option value="">Selecione</option>
        <option value="sim">Sim</option>
        <option value="nao">Não</option>
      </select>
    </label>

    <div id="irPagoValorDiv" class="hidden">
      <label>Informe o valor do IR pago:
        <input type="number" id="irPagoValor" step="0.01" />
      </label>
    </div>

    <!-- Campo Valor Protheus atualizado -->
    <label>Valor Protheus:
      <input type="number" id="valorProtheus" readonly />
    </label>

    <div id="resultados" class="section hidden">
      <h2>Resultados dos Tributos</h2>
      <table>
        <thead>
          <tr>
            <th>Cód.</th>
            <th>Descrição</th>
            <th>Base do Imposto</th>
            <th>Alíquota</th>
            <th>Vlr. Imposto</th>
          </tr>
        </thead>
        <tbody id="tabelaResultados"></tbody>
      </table>
    </div>
  </div>

  <script>
    const irSelect = document.getElementById("irPago");
    const valorInput = document.getElementById("valorPago");
    const irValorDiv = document.getElementById("irPagoValorDiv");
    const irValorInput = document.getElementById("irPagoValor");
    const valorProtheusInput = document.getElementById("valorProtheus");
    const resultados = document.getElementById("resultados");
    const tabelaResultados = document.getElementById("tabelaResultados");
    const dataPagamentoInput = document.getElementById("dataPagamento");
    const labelDataPisIr = document.getElementById("labelDataPisIr");
    const labelDataCide = document.getElementById("labelDataCide");
    const dataPisIrInput = document.getElementById("dataPisIr");
    const dataCideInput = document.getElementById("dataCide");

    irSelect.addEventListener("change", handleIRChange);
    valorInput.addEventListener("input", calcularTributos);
    irValorInput.addEventListener("input", calcularTributos);
    dataPagamentoInput.addEventListener("change", atualizarDatasPagamento);

    function handleIRChange() {
      if (irSelect.value === "sim") {
        irValorDiv.classList.remove("hidden");
      } else {
        irValorDiv.classList.add("hidden");
      }
      calcularTributos();
    }

    function calcularTributos() {
      const valorPago = parseFloat(valorInput.value);
      const irFoiPago = irSelect.value;

      if (isNaN(valorPago) || irFoiPago === "") {
        resultados.classList.add("hidden");
        valorProtheusInput.value = "";
        return;
      }

      const baseISS = valorPago;
      const aliquotaISS = 0.02;
      const valorISS = baseISS * aliquotaISS;

      let baseIR, valorIR, baseCIDE, valorCIDE, basePisCofins, valorPIS, valorCOFINS;

      if (irFoiPago === "nao") {
        baseIR = valorPago / (1 - 0.15);
        valorIR = baseIR * 0.15;
      } else if (irFoiPago === "sim") {
        const irValor = parseFloat(irValorInput.value);
        if (isNaN(irValor) || irValor <= 0) {
          resultados.classList.add("hidden");
          valorProtheusInput.value = "";
          return;
        }
        baseIR = irValor / 0.15;
        valorIR = baseIR * 0.15;
      }

      valorIR = valorIR || 0;

      baseCIDE = baseIR;
      valorCIDE = baseCIDE * 0.10;

      basePisCofins = baseIR / (1 - 0.0165 - 0.0760);
      valorPIS = basePisCofins * 0.0165;
      valorCOFINS = basePisCofins * 0.076;

      // Atualização: Valor Protheus = ValorPago + ValorISS [+ ValorIR se IR=sim]
      let valorProtheusCalc = 0;
      if (irFoiPago === "sim") {
        valorProtheusCalc = valorPago + valorISS + valorIR;
      } else if (irFoiPago === "nao") {
        valorProtheusCalc = valorPago + valorISS;
      }
      valorProtheusInput.value = valorProtheusCalc.toFixed(2);

      tabelaResultados.innerHTML = `
        <tr>
          <td>CID</td>
          <td>CIDE</td>
          <td>${baseCIDE.toFixed(2)}</td>
          <td>10.00%</td>
          <td>${valorCIDE.toFixed(2)}</td>
        </tr>
        <tr>
          <td>ISS</td>
          <td>ISS - Imposto sobre serviço</td>
          <td>${baseISS.toFixed(2)}</td>
          <td>${(aliquotaISS * 100).toFixed(2)}%</td>
          <td>${valorISS.toFixed(2)}</td>
        </tr>
        <tr>
          <td>IRR</td>
          <td>IRRF - Imposto de renda</td>
          <td>${baseIR.toFixed(2)}</td>
          <td>15.00%</td>
          <td>${valorIR.toFixed(2)}</td>
        </tr>
        <tr>
          <td>PS2</td>
          <td>PIS/Pasep - Via apuração</td>
          <td>${basePisCofins.toFixed(2)}</td>
          <td>1.65%</td>
          <td>${valorPIS.toFixed(2)}</td>
        </tr>
        <tr>
          <td>CF2</td>
          <td>COFINS - Via apuração</td>
          <td>${basePisCofins.toFixed(2)}</td>
          <td>7.60%</td>
          <td>${valorCOFINS.toFixed(2)}</td>
        </tr>
      `;

      resultados.classList.remove("hidden");
    }

    function atualizarDatasPagamento() {
      const dataPagamento = dataPagamentoInput.value;
      if (!dataPagamento) {
        labelDataPisIr.classList.add("hidden");
        labelDataCide.classList.add("hidden");
        dataPisIrInput.value = "";
        dataCideInput.value = "";
        return;
      }

      // Exibe os campos
      labelDataPisIr.classList.remove("hidden");
      labelDataCide.classList.remove("hidden");

      dataPisIrInput.value = dataPagamento;

      // Calcula data + 30 dias
      const data = new Date(dataPagamento);
      data.setDate(data.getDate() + 30);
      // Formata para yyyy-mm-dd
      const ano = data.getFullYear();
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const dia = String(data.getDate()).padStart(2, '0');
      dataCideInput.value = `${ano}-${mes}-${dia}`;
    }
  </script>
</body>
</html>
